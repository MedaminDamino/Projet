@page "/admin/roles"
@using BookDashboardBlazor.Models
@using System.Text.Json
@attribute [Authorize(Roles = "SuperAdmin")]
@inject HttpClient Http

<style>
    .badge-superadmin { background-color: #D32F2F !important; color: white; }
    .badge-admin { background-color: #1976D2 !important; color: white; }
    .badge-user { background-color: #388E3C !important; color: white; }
    .badge-default { background-color: #757575 !important; color: white; }
</style>

<h3>Roles</h3>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Role</button>

<GenericTable TItem="RoleDto" Items="roles" OnEdit="@OpenEditModal" OnDelete="@DeleteRole">
    <TableHeader>
        <th>Role Name</th>
        <th>Normalized Name</th>
    </TableHeader>
    <RowTemplate Context="role">
        <td>
            <span class="badge @GetRoleBadgeClass(role.Name)">@role.Name</span>
        </td>
        <td class="text-uppercase text-muted">@role.NormalizedName</td>
    </RowTemplate>
</GenericTable>

<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal" ToastContent="ModalToast">
    <EditForm Model="@currentRole" OnValidSubmit="SaveRole">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Name</label>
            <InputText @bind-Value="currentRole.Name" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal" ToastContent="ModalToast">
    <p>Are you sure you want to delete <strong>@itemToDelete?.Name</strong>?</p>
    <p class="text-muted small">Roles assigned to users cannot be deleted.</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<RoleDto> roles = new();
    private RoleCreateDto currentRole = new();
    private bool showModal = false;
    private bool showDeleteModal = false;
    private RoleDto? itemToDelete = null;
    private string? editingRoleId = null;
    private string modalTitle = "Add Role";

    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private bool showSuccessToast;
    private string? errorMessage;
    private readonly JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        try
        {
            errorMessage = null;
            var response = await Http.GetAsync("api/Roles");
            var content = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<List<RoleDto>>>(content, jsonOptions);
                roles = apiResponse?.Data ?? new List<RoleDto>();
            }
            else
            {
                roles = new List<RoleDto>();
                errorMessage = $"Error loading roles: {(int)response.StatusCode} {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            roles = new List<RoleDto>();
            errorMessage = $"Exception loading roles: {ex.Message}";
        }
    }

    private string GetRoleBadgeClass(string? roleName) => roleName?.ToUpperInvariant() switch
    {
        "SUPERADMIN" => "badge-superadmin",
        "ADMIN" => "badge-admin",
        "USER" => "badge-user",
        _ => "badge-default"
    };

    private void OpenCreateModal()
    {
        ClearModalError();
        editingRoleId = null;
        currentRole = new RoleCreateDto();
        modalTitle = "Add Role";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(RoleDto role)
    {
        ClearModalError();
        editingRoleId = role.Id;
        currentRole = new RoleCreateDto { Name = role.Name };
        modalTitle = "Edit Role";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        ClearModalError();
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveRole()
    {
        ClearModalError();
        var isCreate = string.IsNullOrEmpty(editingRoleId);

        try
        {
            HttpResponseMessage response;
            if (isCreate)
            {
                response = await Http.PostAsJsonAsync("api/Roles", currentRole);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/Roles/{editingRoleId}", new RoleUpdateDto { Name = currentRole.Name });
            }

            var raw = await response.Content.ReadAsStringAsync();
            ApiResponse<RoleDto>? apiResponse = null;
            if (!string.IsNullOrWhiteSpace(raw))
            {
                try
                {
                    apiResponse = JsonSerializer.Deserialize<ApiResponse<RoleDto>>(raw, jsonOptions);
                }
                catch (JsonException ex)
                {
                    Console.WriteLine($"[Roles] JSON parse warning on save: {ex.Message}");
                }
            }

            if (!response.IsSuccessStatusCode)
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to save role (status {(int)response.StatusCode})."),
                    apiResponse?.ErrorCode);
                return;
            }

            if (apiResponse is not null && !apiResponse.Success &&
                (!string.IsNullOrWhiteSpace(apiResponse.Message) || !string.IsNullOrWhiteSpace(apiResponse.ErrorCode)))
            {
                ShowModalError(apiResponse.GetUserMessage($"Failed to save role (status {(int)response.StatusCode})."),
                    apiResponse.ErrorCode);
                return;
            }

            showModal = false;
            await LoadRoles();
            ShowSuccessToast(isCreate ? "Role created successfully" : "Role updated successfully");
        }
        catch (Exception ex)
        {
            ShowModalError($"Error saving role: {ex.Message}", "EXCEPTION");
        }
    }

    private Task DeleteRole(RoleDto role)
    {
        ClearModalError();
        itemToDelete = role;
        showDeleteModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null) return;

        try
        {
            var response = await Http.DeleteAsync($"api/Roles/{itemToDelete.Id}");
            var raw = await response.Content.ReadAsStringAsync();
            ApiResponse<object>? apiResponse = null;
            if (!string.IsNullOrWhiteSpace(raw))
            {
                try
                {
                    apiResponse = JsonSerializer.Deserialize<ApiResponse<object>>(raw, jsonOptions);
                }
                catch (JsonException ex)
                {
                    Console.WriteLine($"[Roles] JSON parse warning on delete: {ex.Message}");
                }
            }

            if (!response.IsSuccessStatusCode)
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to delete role (status {(int)response.StatusCode})."),
                    apiResponse?.ErrorCode);
                return;
            }

            if (apiResponse is not null && !apiResponse.Success)
            {
                ShowModalError(apiResponse.GetUserMessage($"Failed to delete role (status {(int)response.StatusCode})."),
                    apiResponse.ErrorCode);
                return;
            }

            itemToDelete = null;
            showDeleteModal = false;
            StateHasChanged();
            await LoadRoles();
            ShowSuccessToast("Role deleted successfully");
        }
        catch (Exception ex)
        {
            ShowModalError($"Error deleting role: {ex.Message}", "EXCEPTION");
        }
    }

    private Task CloseDeleteModal()
    {
        ClearModalError();
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "Duration", 5000);
        builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(7, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string message, string? code = null)
    {
        modalErrorMessage = message;
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        showSuccessToast = false;
        successMessage = null;
        StateHasChanged();
    }
}
