@page "/admin/user-roles"
@using System.Text.Json
@using System.Linq
@attribute [Authorize(Roles = "SuperAdmin")]
@inject HttpClient Http

<style>
    .badge-superadmin { background-color: #D32F2F !important; color: white; }
    .badge-admin { background-color: #1976D2 !important; color: white; }
    .badge-user { background-color: #388E3C !important; color: white; }
    .badge-norole { background-color: #673AB7 !important; color: white; }

</style>

<h3 class="mb-4">User Roles</h3>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th>User Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoadingUsers)
                {
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2 text-muted">Loading users...</div>
                        </td>
                    </tr>
                }
                else if (users.Count == 0)
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            No users found.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var user in users)
                    {
                        <tr>
                            <td>@user.UserName</td>
                            <td>@user.Email</td>
                            <td>
                                @if (user.Roles.Count == 0)
                                {
                                <span class="badge badge-norole">No role</span>
                                }
                                else
                                {
                                    @foreach (var role in user.Roles)
                                    {
                                        <span class="badge @GetRoleBadgeClass(role) me-1 mb-1">@role</span>
                                    }
                                }
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary"
                                        disabled="@(roles.Count == 0)"
                                        @onclick="() => OpenManageRolesModal(user)">
                                    Change Role
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<Modal Show="showManageModal" Title="@modalTitle" OnClose="CloseManageRolesModal" ToastContent="ModalToast">
    @if (selectedUser is null)
    {
        <p class="text-muted mb-0">Select a user to edit role.</p>
    }
    else if (roles.Count == 0)
    {
        <div class="alert alert-info mb-0">Create roles first to assign them to users.</div>
    }
    else
    {
        <div class="mb-3">
            <strong>@selectedUser.UserName</strong>
            <div class="text-muted small">@selectedUser.Email</div>
        </div>

        <div class="mb-3">
            <label class="form-label d-block">Select Role</label>
            @foreach (var role in roles)
            {
                var radioId = $"role_{role.Id}";
                <div class="form-check">
                    <input class="form-check-input"
                           type="radio"
                           name="userRole"
                           id="@radioId"
                           value="@role.Name"
                           checked="@(selectedRole == role.Name)"
                           @onchange="() => selectedRole = role.Name" />
                    <label class="form-check-label" for="@radioId">
                        <span class="badge @GetRoleBadgeClass(role.Name)">@role.Name</span>
                    </label>
                </div>
            }
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" @onclick="CloseManageRolesModal">Cancel</button>
            <button class="btn btn-primary" @onclick="SaveRoleAsync" disabled="@(isSavingRoles || string.IsNullOrEmpty(selectedRole))">
                @if (isSavingRoles)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                Apply Role
            </button>
        </div>
    }
</Modal>

@code {
    private readonly JsonSerializerOptions jsonOptions = new() { PropertyNameCaseInsensitive = true };
    private List<UserWithRolesDto> users = new();
    private List<RoleDto> roles = new();

    private bool isLoadingUsers = true;
    private bool showManageModal;
    private bool showSuccessToast;
    private bool isSavingRoles;

    private string? errorMessage;
    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private string modalTitle = "Change Role";

    private UserWithRolesDto? selectedUser;
    private string? selectedRole;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadRolesAsync(), LoadUsersAsync());
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            var response = await Http.GetAsync("api/Roles");
            var apiResponse = await DeserializeAsync<List<RoleDto>>(response);
            roles = apiResponse?.Data ?? new List<RoleDto>();

            if (!response.IsSuccessStatusCode || apiResponse is { Success: false })
            {
                errorMessage = apiResponse?.GetUserMessage($"Failed to load roles ({response.StatusCode}).");
            }
            else
            {
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error loading roles: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            isLoadingUsers = true;
            var response = await Http.GetAsync("api/UserRoles/users-with-roles");
            var apiResponse = await DeserializeAsync<List<UserWithRolesDto>>(response);
            users = apiResponse?.Data ?? new List<UserWithRolesDto>();

            if (!response.IsSuccessStatusCode || apiResponse is { Success: false })
            {
                errorMessage = apiResponse?.GetUserMessage($"Failed to load users ({response.StatusCode}).");
            }
            else
            {
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error loading users: {ex.Message}";
        }
        finally
        {
            isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private void OpenManageRolesModal(UserWithRolesDto user)
    {
        selectedUser = user;
        modalTitle = $"Change Role - {user.UserName}";
        selectedRole = user.Roles?.FirstOrDefault();
        showManageModal = true;
        ClearModalError();
    }

    private void CloseManageRolesModal()
    {
        showManageModal = false;
        selectedUser = null;
        selectedRole = null;
        ClearModalError();
    }

    private string GetRoleBadgeClass(string? role) => role?.ToUpperInvariant() switch
    {
        "SUPERADMIN" => "badge badge-superadmin",
        "ADMIN" => "badge badge-admin",
        "USER" => "badge badge-user",
        _ => "badge badge-norole"
    };

    private async Task SaveRoleAsync()
    {
        if (selectedUser == null || string.IsNullOrEmpty(selectedRole))
        {
            return;
        }

        // Check if the role is already the same
        var currentRole = selectedUser.Roles?.FirstOrDefault();
        if (currentRole == selectedRole)
        {
            showManageModal = false;
            ShowSuccessToast("No role changes to apply.");
            return;
        }

        try
        {
            isSavingRoles = true;

            var payload = new SetUserRoleDto
            {
                UserId = selectedUser.UserId,
                RoleName = selectedRole
            };

            var response = await Http.PostAsJsonAsync("api/UserRoles/set-role", payload);
            var apiResponse = await DeserializeAsync<object>(response);

            if (!response.IsSuccessStatusCode || apiResponse is { Success: false })
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to set role ({response.StatusCode})."),
                    apiResponse?.ErrorCode);
                return;
            }

            showManageModal = false;
            await LoadUsersAsync();
            ShowSuccessToast($"Role changed to '{selectedRole}' successfully");
        }
        catch (Exception ex)
        {
            ShowModalError($"Unexpected error updating role: {ex.Message}", "EXCEPTION");
        }
        finally
        {
            isSavingRoles = false;
        }
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(6, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string? message, string? code = null)
    {
        modalErrorMessage = message ?? "An unknown error occurred.";
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        successMessage = null;
        showSuccessToast = false;
        StateHasChanged();
    }

    private async Task<ApiResponse<T>?> DeserializeAsync<T>(HttpResponseMessage response)
    {
        try
        {
            var content = await response.Content.ReadAsStringAsync();
            if (string.IsNullOrWhiteSpace(content))
            {
                return null;
            }

            return JsonSerializer.Deserialize<ApiResponse<T>>(content, jsonOptions);
        }
        catch (JsonException)
        {
            return null;
        }
    }
}
