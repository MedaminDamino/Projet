@page "/authors"
@using BookDashboardBlazor.Models
@inject HttpClient Http
@attribute [Authorize]

<h3>Authors</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error!</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Author</button>

<GenericTable TItem="Author" Items="authors" OnEdit="@OpenEditModal" OnDelete="@DeleteAuthor">
    <TableHeader>
        <th>ID</th>
        <th>Name</th>
        <th>Bio</th>
    </TableHeader>
    <RowTemplate Context="author">
        <td>@author.AuthorId</td>
        <td>@author.Name</td>
        <td>@author.Bio</td>
    </RowTemplate>
</GenericTable>

<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal">
    <EditForm Model="@currentAuthor" OnValidSubmit="SaveAuthor">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Name</label>
            <InputText @bind-Value="currentAuthor.Name" class="form-control" />
        </div>
        <div class="mb-3">
            <label>Bio</label>
            <InputTextArea @bind-Value="currentAuthor.Bio" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal">
    <p>Are you sure you want to delete <strong>@itemToDelete?.Name</strong>?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<Author> authors = new();
    private Author currentAuthor = new();
    private bool showModal = false;
    private bool showDeleteModal = false;
    private Author? itemToDelete = null;
    private string modalTitle = "Add Author";

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthors();
    }

    private async Task LoadAuthors()
    {
        try
        {
            errorMessage = null;
            authors = await Http.GetFromJsonAsync<List<Author>>("api/Author") ?? new List<Author>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading authors: {ex.Message}. Is the backend API running?";
            Console.WriteLine(ex);
        }
    }

    private void OpenCreateModal()
    {
        currentAuthor = new Author();
        modalTitle = "Add Author";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Author author)
    {
        currentAuthor = new Author
        {
            AuthorId = author.AuthorId,
            Name = author.Name,
            Bio = author.Bio
        };
        modalTitle = "Edit Author";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveAuthor()
    {
        if (currentAuthor.AuthorId == 0)
        {
            await Http.PostAsJsonAsync("api/Author", currentAuthor);
        }
        else
        {
            await Http.PutAsJsonAsync($"api/Author/{currentAuthor.AuthorId}", currentAuthor);
        }
        showModal = false;
        await LoadAuthors();
    }

    private Task DeleteAuthor(Author author)
    {
        itemToDelete = author;
        showDeleteModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null) return;

        await Http.DeleteAsync($"api/Author/{itemToDelete.AuthorId}");
        itemToDelete = null;
        showDeleteModal = false;
        StateHasChanged();
        await LoadAuthors();
    }

    private Task CloseDeleteModal()
    {
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
