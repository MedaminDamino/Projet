@page "/books"
@using BookDashboardBlazor.Models
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@attribute [Authorize(Roles = "SuperAdmin,Admin")]

<h3>Books</h3>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error!</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Book</button>

<GenericTable TItem="Book" Items="books" OnEdit="@OpenEditModal" OnDelete="@DeleteBook">
    <TableHeader>
        <th style="width:80px;">Cover</th>
        <th>ID</th>
        <th>Title</th>
        <th>Author</th>
        <th>Genre</th>
        <th>Year</th>
        <th>Description</th>
    </TableHeader>
    <RowTemplate Context="book">
        <td>
            <div style="width:60px;height:60px;background:#f3f4f6;border-radius:6px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                <img src="@ResolveImageUrl(book.ImageUrl)"
                     alt="@($"{book.Title} cover")"
                     onerror="@ImageErrorFallbackJs"
                     style="width:100%;height:100%;object-fit:cover;display:block;" />
            </div>
        </td>
        <td>@book.BookId</td>
        <td>@book.Title</td>
        <td>
            <button class="btn btn-link p-0" @onclick="() => ShowAuthorDetails(book.AuthorId)">
                @GetAuthorName(book.AuthorId)
            </button>
        </td>
        <td>
            <button class="btn btn-link p-0" @onclick="() => ShowGenreDetails(book.GenreId)">
                @GetGenreName(book.GenreId)
            </button>
        </td>
        <td>@book.PublishYear</td>
        <td>@book.Description</td>
    </RowTemplate>
</GenericTable>

@* Create/Edit Modal *@
<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal" ToastContent="ModalToast">
    @* Use OnSubmit so SaveBook ALWAYS runs (even if validation fails) *@
    <EditForm Model="@currentBook" OnSubmit="SaveBook">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Title</label>
            <InputText @bind-Value="currentBook.Title" class="form-control" />
        </div>
        <div class="mb-3">
            <label>Author</label>
            <InputSelect @bind-Value="currentBook.AuthorId" class="form-select">
                <option value="0">Select Author</option>
                @foreach (var author in authors)
                {
                    <option value="@author.AuthorId">@author.Name</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label>Genre</label>
            <InputSelect @bind-Value="currentBook.GenreId" class="form-select">
                <option value="0">Select Genre</option>
                @foreach (var genre in genres)
                {
                    <option value="@genre.GenreId">@genre.GenreName</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label>Publish Year</label>
            <InputNumber @bind-Value="currentBook.PublishYear" class="form-control" />
        </div>
        <div class="mb-3">
            <label>Description</label>
            <InputTextArea @bind-Value="currentBook.Description" class="form-control" />
        </div>
        <div class="mb-3">
            <label class="form-label fw-semibold">Cover Image</label>
            <div class="upload-card d-flex align-items-center gap-3 flex-wrap">
                <div class="cover-preview d-flex align-items-center justify-content-center text-muted">
                    <img src="@imagePreviewUrl" alt="Cover preview" onerror="@ImageErrorFallbackJs" />
                </div>
                <div class="flex-grow-1">
                    <label class="btn btn-outline-primary btn-sm mb-2">
                        <i class="bi bi-upload me-1"></i>Choose file
                        <InputFile class="d-none" OnChange="OnImageSelected" accept="image/*" />
                    </label>
                    <div class="small text-muted">
                        JPG/PNG up to 5MB. Leave empty to keep current.
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

@* Detail Modal *@
<Modal Show="showDetailModal" Title="@detailTitle" OnClose="CloseDetailModal">
    @if (selectedAuthor != null)
    {
        <p><strong>Name:</strong> @selectedAuthor.Name</p>
        <p><strong>Bio:</strong> @selectedAuthor.Bio</p>
    }
    else if (selectedGenre != null)
    {
        <p><strong>Name:</strong> @selectedGenre.GenreName</p>
    }
</Modal>

@* Delete Confirmation Modal *@
<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal" ToastContent="ModalToast">
    <p>Are you sure you want to delete <strong>@itemToDelete?.Title</strong>?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private const string PlaceholderImage = "/images/book-placeholder.svg";
    private string ImageErrorFallbackJs => $"this.onerror=null; this.src='{PlaceholderImage}';";

    private List<Book> books = new();
    private List<Author> authors = new();
    private List<Genre> genres = new();

    private Book currentBook = new();
    private Book? itemToDelete = null; // for delete modal

    private IBrowserFile? selectedImageFile;
    private string imagePreviewUrl = PlaceholderImage;
    private bool showModal = false;
    private string modalTitle = "Add Book";

    // Detail Modal State
    private bool showDetailModal = false;
    private string detailTitle = "";
    private Author? selectedAuthor;
    private Genre? selectedGenre;

    // Delete Modal State
    private bool showDeleteModal = false;

    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private bool showSuccessToast;

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("[Books] OnInitializedAsync called");
        await LoadData();
    }

    private async Task LoadData()
    {
        errorMessage = null;
        try
        {
            Console.WriteLine("[Books] Loading data from API...");
            var booksTask = GetListSafeAsync<Book>("api/Books");
            var authorsTask = GetListSafeAsync<Author>("api/Author");
            var genresTask = GetListSafeAsync<Genre>("api/Genre");

            await Task.WhenAll(booksTask, authorsTask, genresTask);

            books = await booksTask;
            authors = await authorsTask;
            genres = await genresTask;

            Console.WriteLine($"[Books] Loaded {books.Count} books, {authors.Count} authors, {genres.Count} genres");
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error loading data: {ex.Message}";
            Console.WriteLine($"[Books] Exception in LoadData: {ex}");
        }
    }

    private async Task<List<T>> GetListSafeAsync<T>(string url)
    {
        try
        {
            Console.WriteLine($"[Books] GET {url}");
            var result = await Http.GetFromJsonAsync<List<T>>(url) ?? new List<T>();
            Console.WriteLine($"[Books] GET {url} returned {result.Count} items");
            return result;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Books] Error fetching {url}: {ex.Message}");
            return new List<T>();
        }
    }

    private string GetAuthorName(int? id) => id.HasValue
        ? authors.FirstOrDefault(a => a.AuthorId == id.Value)?.Name ?? "Unknown"
        : "Unknown";

    private string GetGenreName(int? id) => id.HasValue
        ? genres.FirstOrDefault(g => g.GenreId == id.Value)?.GenreName ?? "Unknown"
        : "Unknown";

    private void OpenCreateModal()
    {
        Console.WriteLine("[Books] OpenCreateModal clicked");
        ClearModalError();
        currentBook = new Book();
        selectedImageFile = null;
        imagePreviewUrl = PlaceholderImage;
        modalTitle = "Add Book";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Book book)
    {
        Console.WriteLine($"[Books] OpenEditModal for BookId={book.BookId}, Title='{book.Title}'");
        ClearModalError();
        currentBook = new Book
        {
            BookId = book.BookId,
            Title = book.Title,
            AuthorId = book.AuthorId,
            GenreId = book.GenreId,
            PublishYear = book.PublishYear,
            Description = book.Description,
            ImageUrl = book.ImageUrl
        };
        selectedImageFile = null;
        imagePreviewUrl = ResolveImageUrl(book.ImageUrl);
        modalTitle = "Edit Book";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        Console.WriteLine("[Books] CloseModal called");
        ClearModalError();
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveBook()
    {
        Console.WriteLine($"[Books] SaveBook called. BookId={currentBook.BookId}, Title='{currentBook.Title}'");
        var isCreate = currentBook.BookId == 0;
        ClearModalError();
        errorMessage = null;

        using var content = BuildMultipartContent();

        HttpResponseMessage response;
        try
        {
            if (currentBook.BookId == 0)
            {
                Console.WriteLine("[Books] Creating new book via POST api/Books");
                response = await Http.PostAsync("api/Books", content);
            }
            else
            {
                Console.WriteLine($"[Books] Updating book via PUT api/Books/{currentBook.BookId}");
                response = await Http.PutAsync($"api/Books/{currentBook.BookId}", content);
            }
        }
        catch (Exception ex)
        {
            ShowModalError($"Request failed: {ex.Message}", "REQUEST_FAILED");
            Console.WriteLine($"[Books] Exception during SaveBook HTTP call: {ex}");
            return;
        }

        var jsonContent = await response.Content.ReadAsStringAsync();
        Console.WriteLine($"[Books] SaveBook HTTP status: {(int)response.StatusCode} {response.StatusCode}");
        Console.WriteLine($"[Books] SaveBook response body (first 300 chars): {jsonContent.Substring(0, Math.Min(300, jsonContent.Length))}");

        var options = new System.Text.Json.JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        };

        try
        {
            // Try to parse as ApiResponse<Book> (like ReadingList)
            var apiResponse =
                System.Text.Json.JsonSerializer.Deserialize<ApiResponse<Book>>(jsonContent, options);

            if (apiResponse != null && apiResponse.Success)
            {
                Console.WriteLine($"[Books] SaveBook ApiResponse.Success = true. BookId={apiResponse.Data?.BookId}");
            }
            else if (!response.IsSuccessStatusCode)
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to save book (status {(int)response.StatusCode})."),
                    apiResponse?.ErrorCode);
                Console.WriteLine($"[Books] Error saving book: {modalErrorMessage} (Code: {apiResponse?.ErrorCode})");
                return;
            }
            else
            {
                // No wrapper but HTTP OK -> treat as success
                Console.WriteLine("[Books] SaveBook succeeded with non-wrapped response.");
            }
        }
        catch (System.Text.Json.JsonException jsonEx)
        {
            Console.WriteLine($"[Books] JSON parse error in SaveBook: {jsonEx.Message}");
            // Fallback: if Books endpoint returns plain Book or simple message
            if (!response.IsSuccessStatusCode)
            {
                ShowModalError($"Failed to save book (status {(int)response.StatusCode}). Server says: {jsonContent}",
                    "HTTP_ERROR");
                Console.WriteLine($"[Books] Fallback SaveBook error: {modalErrorMessage}");
                return;
            }

            Console.WriteLine("[Books] SaveBook fallback: treating response as success without ApiResponse wrapper.");
        }

        // Success
        Console.WriteLine("[Books] SaveBook succeeded, closing modal and reloading data.");
        showModal = false;
        await LoadData();
        ShowSuccessToast(isCreate ? "Book created successfully" : "Book updated successfully");
    }

    private async Task DeleteBook(Book book)
    {
        // Called from GenericTable OnDelete
        Console.WriteLine($"[Books] DeleteBook clicked for BookId={book.BookId}, Title='{book.Title}'");
        await Task.CompletedTask; // keep async signature
        ClearModalError();
        itemToDelete = book;
        showDeleteModal = true;
        StateHasChanged();
    }

    private void CloseDeleteModal()
    {
        Console.WriteLine("[Books] CloseDeleteModal called");
        ClearModalError();
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null)
        {
            Console.WriteLine("[Books] ConfirmDelete called but itemToDelete is null");
            return;
        }

        Console.WriteLine($"[Books] ConfirmDelete for BookId={itemToDelete.BookId}, Title='{itemToDelete.Title}'");

        try
        {
            ClearModalError();
            var deletingId = itemToDelete.BookId;
            var deletingTitle = itemToDelete.Title;

            Console.WriteLine($"[Books] Sending DELETE api/Books/{deletingId}");
            var response = await Http.DeleteAsync($"api/Books/{deletingId}");
            var jsonContent = await response.Content.ReadAsStringAsync();

            Console.WriteLine($"[Books] ConfirmDelete HTTP status: {(int)response.StatusCode} {response.StatusCode}");
            Console.WriteLine($"[Books] ConfirmDelete response body (first 300 chars): {jsonContent.Substring(0, Math.Min(300, jsonContent.Length))}");

            var options = new System.Text.Json.JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };

            try
            {
                // Try ApiResponse<object> like ReadingList
                var apiResponse =
                    System.Text.Json.JsonSerializer.Deserialize<ApiResponse<object>>(jsonContent, options);

                if (apiResponse != null && apiResponse.Success)
                {
                    Console.WriteLine($"[Books] ConfirmDelete ApiResponse.Success = true. Removing from local list BookId={deletingId}");

                    books.RemoveAll(b => b.BookId == deletingId);

                    showDeleteModal = false;
                    itemToDelete = null;
                    StateHasChanged();

                    Console.WriteLine("[Books] ConfirmDelete reloading data from server...");
                    await LoadData();
                    ShowSuccessToast("Book deleted successfully");
                    return;
                }

                ShowModalError(apiResponse?.GetUserMessage($"Failed to delete book: {response.StatusCode}"),
                    apiResponse?.ErrorCode);
                Console.WriteLine($"[Books] Error deleting book: {modalErrorMessage} (Code: {apiResponse?.ErrorCode})");
            }
            catch (System.Text.Json.JsonException jsonEx)
            {
                Console.WriteLine($"[Books] JSON parse error in ConfirmDelete: {jsonEx.Message}");

                // Fallback: endpoint returns no wrapper
                if (!response.IsSuccessStatusCode)
                {
                    ShowModalError($"Failed to delete book (status {(int)response.StatusCode}). Server says: {jsonContent}",
                        "HTTP_ERROR");
                    Console.WriteLine($"[Books] Fallback delete error: {modalErrorMessage}");
                }
                else
                {
                    Console.WriteLine($"[Books] ConfirmDelete fallback: treating delete as success. Removing BookId={deletingId} locally.");
                    books.RemoveAll(b => b.BookId == deletingId);
                    StateHasChanged();
                    showDeleteModal = false;
                    itemToDelete = null;
                    await LoadData();
                    ShowSuccessToast("Book deleted successfully");
                }
            }
        }
        catch (Exception ex)
        {
            ShowModalError($"Error deleting book: {ex.Message}", "EXCEPTION");
            Console.WriteLine($"[Books] Exception in ConfirmDelete: {ex}");
        }
    }

    // Detail Modal Logic
    private void ShowAuthorDetails(int authorId)
    {
        Console.WriteLine($"[Books] ShowAuthorDetails for AuthorId={authorId}");
        selectedAuthor = authors.FirstOrDefault(a => a.AuthorId == authorId);
        selectedGenre = null;
        if (selectedAuthor != null)
        {
            detailTitle = "Author Details";
            showDetailModal = true;
        }
        else
        {
            Console.WriteLine("[Books] ShowAuthorDetails: author not found");
        }
    }

    private void ShowGenreDetails(int genreId)
    {
        Console.WriteLine($"[Books] ShowGenreDetails for GenreId={genreId}");
        selectedGenre = genres.FirstOrDefault(g => g.GenreId == genreId);
        selectedAuthor = null;
        if (selectedGenre != null)
        {
            detailTitle = "Genre Details";
            showDetailModal = true;
        }
        else
        {
            Console.WriteLine("[Books] ShowGenreDetails: genre not found");
        }
    }

    private void CloseDetailModal()
    {
        Console.WriteLine("[Books] CloseDetailModal called");
        showDetailModal = false;
    }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        selectedImageFile = e.File;
        const long maxFileSize = 5 * 1024 * 1024;

        Console.WriteLine($"[Books] OnImageSelected: file '{selectedImageFile.Name}', size={selectedImageFile.Size}");

        try
        {
            await using var stream = selectedImageFile.OpenReadStream(maxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            imagePreviewUrl = $"data:{selectedImageFile.ContentType};base64,{base64}";
            Console.WriteLine("[Books] OnImageSelected: preview URL generated");
        }
        catch (Exception ex)
        {
            ShowModalError($"Image load failed: {ex.Message}", "IMAGE_ERROR");
            Console.WriteLine($"[Books] Exception in OnImageSelected: {ex}");
            selectedImageFile = null;
            imagePreviewUrl = PlaceholderImage;
        }
    }

    private MultipartFormDataContent BuildMultipartContent()
    {
        Console.WriteLine("[Books] BuildMultipartContent called");
        Console.WriteLine($"[Books]   Title='{currentBook.Title}', AuthorId={currentBook.AuthorId}, GenreId={currentBook.GenreId}, PublishYear={currentBook.PublishYear}, HasImageFile={selectedImageFile != null}");

        var content = new MultipartFormDataContent();
        content.Add(new StringContent(currentBook.Title ?? string.Empty), "Title");
        content.Add(new StringContent(currentBook.AuthorId.ToString()), "AuthorId");
        content.Add(new StringContent(currentBook.GenreId.ToString()), "GenreId");
        if (currentBook.PublishYear.HasValue)
        {
            content.Add(new StringContent(currentBook.PublishYear.Value.ToString()), "PublishYear");
        }
        content.Add(new StringContent(currentBook.Description ?? string.Empty), "Description");

        if (selectedImageFile != null)
        {
            var fileContent = new StreamContent(selectedImageFile.OpenReadStream(5 * 1024 * 1024));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedImageFile.ContentType);
            content.Add(fileContent, "Image", selectedImageFile.Name);
        }

        return content;
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "Duration", 5000);
        builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(7, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string message, string? code = null)
    {
        modalErrorMessage = message;
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        showSuccessToast = false;
        successMessage = null;
        StateHasChanged();
    }

    private string ResolveImageUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url))
        {
            return PlaceholderImage;
        }

        if (Uri.TryCreate(url, UriKind.Absolute, out var absolute) &&
            (absolute.Scheme == Uri.UriSchemeHttp || absolute.Scheme == Uri.UriSchemeHttps))
        {
            return absolute.ToString();
        }

        var baseUri = Http.BaseAddress;
        if (baseUri == null || baseUri.Scheme == Uri.UriSchemeFile)
        {
            baseUri = new Uri("http://localhost:5069/");
        }

        try
        {
            return new Uri(baseUri, url.TrimStart('/')).ToString();
        }
        catch
        {
            return PlaceholderImage;
        }
    }
}
