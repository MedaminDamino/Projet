@page "/genres"
@using BookDashboardBlazor.Models
@inject HttpClient Http
@attribute [Authorize]

<h3>Genres</h3>

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Genre</button>

<GenericTable TItem="Genre" Items="genres" OnEdit="@OpenEditModal" OnDelete="@DeleteGenre">
    <TableHeader>
        <th>ID</th>
        <th>Name</th>
    </TableHeader>
    <RowTemplate Context="genre">
        <td>@genre.GenreId</td>
        <td>@genre.GenreName</td>
    </RowTemplate>
</GenericTable>

<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal">
    <EditForm Model="@currentGenre" OnValidSubmit="SaveGenre">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Name</label>
            <InputText @bind-Value="currentGenre.GenreName" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal">
    <p>Are you sure you want to delete <strong>@itemToDelete?.GenreName</strong>?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<Genre> genres = new();
    private Genre currentGenre = new();
    private bool showModal = false;
    private bool showDeleteModal = false;
    private Genre? itemToDelete = null;
    private string modalTitle = "Add Genre";

    protected override async Task OnInitializedAsync()
    {
        await LoadGenres();
    }

    private async Task LoadGenres()
    {
        try
        {
            var response = await Http.GetAsync("api/Genre");
            if (response.IsSuccessStatusCode)
            {
                genres = await response.Content.ReadFromJsonAsync<List<Genre>>() ?? new List<Genre>();
            }
            else
            {
                genres = new List<Genre>();
                Console.WriteLine($"Error loading genres: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            genres = new List<Genre>();
            Console.WriteLine($"Exception loading genres: {ex.Message}");
        }
    }

    private void OpenCreateModal()
    {
        currentGenre = new Genre();
        modalTitle = "Add Genre";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Genre genre)
    {
        currentGenre = new Genre
        {
            GenreId = genre.GenreId,
            GenreName = genre.GenreName
        };
        modalTitle = "Edit Genre";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveGenre()
    {
        try
        {
            if (currentGenre.GenreId == 0)
            {
                var response = await Http.PostAsJsonAsync("api/Genre", currentGenre);
                if (!response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"Error creating genre: {response.StatusCode}");
                    return;
                }
            }
            else
            {
                var response = await Http.PutAsJsonAsync($"api/Genre/{currentGenre.GenreId}", currentGenre);
                if (!response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"Error updating genre: {response.StatusCode}");
                    return;
                }
            }
            showModal = false;
            await LoadGenres();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception saving genre: {ex.Message}");
        }
    }

    private Task DeleteGenre(Genre genre)
    {
        itemToDelete = genre;
        showDeleteModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null) return;

        try
        {
            var response = await Http.DeleteAsync($"api/Genre/{itemToDelete.GenreId}");
            showDeleteModal = false;
            itemToDelete = null;
            StateHasChanged();

            if (response.IsSuccessStatusCode)
            {
                await LoadGenres();
            }
            else
            {
                Console.WriteLine($"Error deleting genre: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception deleting genre: {ex.Message}");
            showDeleteModal = false;
            itemToDelete = null;
            StateHasChanged();
        }
    }

    private Task CloseDeleteModal()
    {
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
