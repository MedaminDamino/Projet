@page "/goals"
@using BookDashboardBlazor.Models
@inject HttpClient Http
@attribute [Authorize(Roles = "SuperAdmin,Admin")]

<h3>Reading Goals</h3>

<!-- Global success toast (top-right) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        @if (!string.IsNullOrEmpty(errorCode))
        {
            <br />
            <small><strong>Error Code:</strong> @errorCode</small>
        }
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Goal</button>

<GenericTable TItem="ReadingGoal" Items="goals" OnEdit="@OpenEditModal" OnDelete="@DeleteGoal">
    <TableHeader>
        <th>ID</th>
        <th>Year</th>
        <th>Goal</th>
        <th>Progress</th>
        <th>Book</th>
    </TableHeader>
    <RowTemplate Context="goal">
        <td>@goal.Id</td>
        <td>@goal.Year</td>
        <td>@goal.Goal</td>
        <td>@goal.Progress</td>
        <td>@(goal.Book?.Title ?? "Unknown")</td>
    </RowTemplate>
</GenericTable>

@* Create / Edit Modal *@
<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal" ToastContent="ModalToast">
    <EditForm Model="@currentGoal" OnValidSubmit="SaveGoal">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Year</label>
            <InputNumber @bind-Value="currentGoal.Year" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Goal (books per year)</label>
            <InputNumber @bind-Value="currentGoal.Goal" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Progress</label>
            <InputNumber @bind-Value="currentGoal.Progress" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Book</label>
            <select class="form-control" @bind="currentGoal.BookId">
                <option value="0">Select a book...</option>
                @foreach (var book in books)
                {
                    <option value="@book.BookId">@book.Title</option>
                }
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

@* Delete confirmation modal *@
<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal" ToastContent="ModalToast">
    <p>Are you sure you want to delete goal <strong>@itemToDelete?.Goal</strong> for year <strong>@itemToDelete?.Year</strong>?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<ReadingGoal> goals = new();
    private List<Book> books = new();

    private ReadingGoal currentGoal = new();
    private ReadingGoal? itemToDelete;

    private bool showModal;
    private bool showDeleteModal;
    private string modalTitle = "Add Goal";

    private string? errorMessage;
    private string? errorCode;
    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private bool showSuccessToast;

    private readonly System.Text.Json.JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private void ClearError()
    {
        errorMessage = null;
        errorCode = null;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("[Goals] OnInitializedAsync called");
        await LoadBooks();
        await LoadGoals();
    }

    private async Task LoadBooks()
    {
        try
        {
            Console.WriteLine("[Goals] Loading books...");
            books = await Http.GetFromJsonAsync<List<Book>>("api/Books") ?? new List<Book>();
            Console.WriteLine($"[Goals] Loaded {books.Count} books");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Goals] Error loading books: {ex.Message}");
            errorMessage = $"Error loading books: {ex.Message}";
        }
    }

    private async Task LoadGoals()
    {
        try
        {
            ClearError();
            Console.WriteLine("[Goals] Loading books and goals");

            var response = await Http.GetAsync("api/ReadingGoal");
            var jsonContent = await response.Content.ReadAsStringAsync();

            Console.WriteLine($"[Goals] Goals status {((int)response.StatusCode)}, raw response: {jsonContent}");

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                // API is telling us user not authenticated
                try
                {
                    var apiError = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<object>>(jsonContent, jsonOptions);
                    errorMessage = apiError?.Message ?? "User not authenticated";
                    errorCode = apiError?.ErrorCode ?? "UNAUTHORIZED";
                }
                catch
                {
                    errorMessage = "User not authenticated";
                    errorCode = "UNAUTHORIZED";
                }

                goals = new List<ReadingGoal>();
                Console.WriteLine("[Goals] Unauthorized when loading goals");
                return;
            }

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"API Error: {response.StatusCode}";
                Console.WriteLine($"[Goals] API error when loading goals: {response.StatusCode}");
                goals = new List<ReadingGoal>();
                return;
            }

            try
            {
                var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<List<ReadingGoal>>>(jsonContent, jsonOptions);

                if (apiResponse == null || !apiResponse.Success || apiResponse.Data == null)
                {
                    errorMessage = apiResponse?.Message ?? "Failed to load goals";
                    errorCode = apiResponse?.ErrorCode;
                    Console.WriteLine($"[Goals] API unsuccessful: {apiResponse?.Message}");
                    goals = new List<ReadingGoal>();
                    return;
                }

                goals = apiResponse.Data;
                Console.WriteLine($"[Goals] Loaded {goals.Count} goals");
                StateHasChanged();
            }
            catch (System.Text.Json.JsonException jsonEx)
            {
                Console.WriteLine($"[Goals] JSON error: {jsonEx.Message}");
                errorMessage = $"Error parsing goals data: {jsonEx.Message}";
                goals = new List<ReadingGoal>();
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"[Goals] HTTP exception: {ex}");
            errorMessage = $"HTTP Error loading goals: {ex.Message}";
            goals = new List<ReadingGoal>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Goals] Exception loading goals: {ex}");
            errorMessage = $"Error loading goals: {ex.Message}";
            goals = new List<ReadingGoal>();
        }
    }

    private void OpenCreateModal()
    {
        Console.WriteLine("[Goals] OpenCreateModal clicked");
        ClearModalError();

        currentGoal = new ReadingGoal
        {
            Year = DateTime.Now.Year,
            Goal = 0,
            Progress = 0,
            BookId = 0
        };

        modalTitle = "Add Goal";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(ReadingGoal goal)
    {
        Console.WriteLine($"[Goals] OpenEditModal for Id={goal.Id}");
        ClearModalError();

        currentGoal = new ReadingGoal
        {
            Id = goal.Id,
            UserId = goal.UserId,
            ApplicationUserId = goal.ApplicationUserId,
            BookId = goal.BookId,
            Year = goal.Year,
            Goal = goal.Goal,
            Progress = goal.Progress,
            CreatedAt = goal.CreatedAt,
            Book = goal.Book
        };

        modalTitle = "Edit Goal";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        Console.WriteLine("[Goals] CloseModal called");
        ClearModalError();
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveGoal()
    {
        try
        {
            ClearError();
            ClearModalError();

            var isCreate = currentGoal.Id == 0;

            if (currentGoal.BookId == 0)
            {
                ShowModalError("Please select a book.", "VALIDATION_ERROR");
                return;
            }

            HttpResponseMessage response;
            if (isCreate)
            {
                Console.WriteLine("[Goals] Creating goal");
                response = await Http.PostAsJsonAsync("api/ReadingGoal", currentGoal);
            }
            else
            {
                Console.WriteLine($"[Goals] Updating goal Id={currentGoal.Id}");
                response = await Http.PutAsJsonAsync($"api/ReadingGoal/{currentGoal.Id}", currentGoal);
            }

            var jsonContent = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"[Goals] Save response: {jsonContent}");

            var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<ReadingGoal>>(jsonContent, jsonOptions);

            if (apiResponse == null || !apiResponse.Success)
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to {(isCreate ? "create" : "update")} goal: {response.StatusCode}"),
                               apiResponse?.ErrorCode);
                Console.WriteLine($"[Goals] Error saving goal: {modalErrorMessage} (Code: {modalErrorCode})");
                return;
            }

            showModal = false;
            await LoadGoals();
            ShowSuccessToast(isCreate ? "Goal created successfully" : "Goal updated successfully");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Goals] Exception saving goal: {ex}");
            ShowModalError($"Error saving goal: {ex.Message}", "EXCEPTION");
            StateHasChanged();
        }
    }

    private async Task DeleteGoal(ReadingGoal goal)
    {
        Console.WriteLine($"[Goals] DeleteGoal clicked for Id={goal.Id}");
        ClearModalError();
        itemToDelete = goal;
        showDeleteModal = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void CloseDeleteModal()
    {
        Console.WriteLine("[Goals] CloseDeleteModal called");
        ClearModalError();
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null)
        {
            Console.WriteLine("[Goals] ConfirmDelete with no item");
            return;
        }

        try
        {
            ClearError();
            ClearModalError();

            Console.WriteLine($"[Goals] Deleting goal Id={itemToDelete.Id}");
            var response = await Http.DeleteAsync($"api/ReadingGoal/{itemToDelete.Id}");
            var jsonContent = await response.Content.ReadAsStringAsync();

            Console.WriteLine($"[Goals] Delete response: {jsonContent}");

            var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<object>>(jsonContent, jsonOptions);

            if (apiResponse != null && apiResponse.Success)
            {
                Console.WriteLine($"[Goals] Successfully deleted Id={itemToDelete.Id}");

                goals.RemoveAll(g => g.Id == itemToDelete.Id);

                showDeleteModal = false;
                itemToDelete = null;

                StateHasChanged();

                await LoadGoals();
                ShowSuccessToast("Goal deleted successfully");
            }
            else
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to delete goal: {response.StatusCode}"),
                               apiResponse?.ErrorCode);
                Console.WriteLine($"[Goals] Error deleting goal: {modalErrorMessage} (Code: {modalErrorCode})");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Goals] Exception deleting goal: {ex}");
            ShowModalError($"Error deleting goal: {ex.Message}", "EXCEPTION");
        }
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "Duration", 5000);
        builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(7, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string message, string? code = null)
    {
        modalErrorMessage = message;
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        showSuccessToast = false;
        successMessage = null;
        StateHasChanged();
    }
}
