@page "/readinglist"
@using BookDashboardBlazor.Models
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "SuperAdmin,Admin")]

<h3>Reading List</h3>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        @if (!string.IsNullOrEmpty(errorCode))
        {
            <br />
            <small><strong>Error Code:</strong> @errorCode</small>
        }
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add to Reading List</button>

<GenericTable TItem="ReadingList" Items="readingList" OnEdit="@OpenEditModal" OnDelete="@DeleteReadingList">
    <TableHeader>
        <th>ID</th>
        <th>Book Title</th>
        <th>Status</th>
        <th>Added Date</th>
    </TableHeader>
    <RowTemplate Context="item">
        <td>@item.ReadingListID</td>
        <td>@item.Book?.Title</td>
        <td>@item.Status</td>
        <td>@item.AddedAt.ToString("MMM dd, yyyy")</td>
    </RowTemplate>
</GenericTable>

@* Edit/Add Modal *@
<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal" ToastContent="ModalToast">
    <EditForm Model="@currentReadingList" OnValidSubmit="SaveReadingList">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Book</label>
            <select class="form-control" @bind="currentReadingList.BookId">
                <option value="0">Select a book...</option>
                @foreach (var book in books)
                {
                    <option value="@book.BookId">@book.Title</option>
                }
            </select>
        </div>

        <div class="mb-3">
            <label>Status</label>
            <select class="form-control" @bind="currentReadingList.Status">
                <option value="Not Started">Not Started</option>
                <option value="Reading">Reading</option>
                <option value="Completed">Completed</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

@* Delete Confirmation Modal *@
<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal" ToastContent="ModalToast">
    <p>Are you sure you want to remove <strong>@itemToDelete?.Book?.Title</strong> from your reading list?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<ReadingList> readingList = new();
    private List<Book> books = new();
    private ReadingList currentReadingList = new();
    private ReadingList? itemToDelete = null;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private string modalTitle = "Add to Reading List";
    private string? errorMessage;
    private string? errorCode;
    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private bool showSuccessToast;

    private readonly System.Text.Json.JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    private void ClearError()
    {
        errorMessage = null;
        errorCode = null;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
        await LoadReadingList();
    }

    private async Task LoadBooks()
    {
        try
        {
            books = await Http.GetFromJsonAsync<List<Book>>("api/Books") ?? new List<Book>();
            Console.WriteLine($"Loaded {books.Count} books");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception loading books: {ex.Message}");
            errorMessage = $"Error loading books: {ex.Message}";
        }
    }

    private async Task LoadReadingList()
    {
        try
        {
            ClearError();
            Console.WriteLine("Attempting to load reading list from api/ReadingList...");

            var response = await Http.GetAsync("api/ReadingList");
            var jsonContent = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Raw API Response: {jsonContent.Substring(0, Math.Min(200, jsonContent.Length))}...");

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"API Error: {response.StatusCode}";
                Console.WriteLine($"API returned error: {response.StatusCode}");
                readingList = new List<ReadingList>();
                return;
            }

            try
            {
                var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<List<ReadingList>>>(jsonContent, jsonOptions);

                if (apiResponse == null || !apiResponse.Success || apiResponse.Data == null)
                {
                    errorMessage = apiResponse?.Message ?? "Failed to load reading list";
                    errorCode = apiResponse?.ErrorCode;
                    Console.WriteLine($"API returned unsuccessful response: {apiResponse?.Message}");
                    readingList = new List<ReadingList>();
                    return;
                }

                readingList = apiResponse.Data;

                Console.WriteLine($"Successfully loaded {readingList.Count} reading list items");
                foreach (var item in readingList)
                {
                    Console.WriteLine($"ReadingList ID: {item.ReadingListID}, BookId: {item.BookId}, Book is null: {item.Book == null}");
                    if (item.Book != null)
                    {
                        Console.WriteLine($"  Book Title: '{item.Book.Title}', BookId: {item.Book.BookId}");
                    }
                }

                StateHasChanged();
            }
            catch (System.Text.Json.JsonException jsonEx)
            {
                Console.WriteLine($"JSON Deserialization Error: {jsonEx.Message}");
                Console.WriteLine($"JSON Path: {jsonEx.Path}");
                errorMessage = $"Error parsing data: {jsonEx.Message}";
                readingList = new List<ReadingList>();
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"HTTP Error loading reading list: {ex.Message}";
            Console.WriteLine($"HTTP Exception loading reading list: {ex}");
            readingList = new List<ReadingList>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading reading list: {ex.Message}";
            Console.WriteLine($"Exception loading reading list: {ex}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            readingList = new List<ReadingList>();
        }
    }

    private void OpenCreateModal()
    {
        Console.WriteLine("Opening Create modal");
        ClearModalError();
        currentReadingList = new ReadingList
        {
            Status = "Not Started",
            AddedAt = DateTime.Now
        };
        modalTitle = "Add to Reading List";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(ReadingList item)
    {
        Console.WriteLine($"Opening Edit modal for item ID: {item.ReadingListID}");
        ClearModalError();
        currentReadingList = new ReadingList
        {
            ReadingListID = item.ReadingListID,
            AppUserID = item.AppUserID,
            BookId = item.BookId,
            Status = item.Status,
            AddedAt = item.AddedAt,
            Book = item.Book
        };
        modalTitle = "Edit Reading List";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        Console.WriteLine("Closing modal");
        ClearModalError();
        showModal = false;
        StateHasChanged();
    }

    private async Task SaveReadingList()
    {
        try
        {
            ClearError();
            ClearModalError();

            var isCreate = currentReadingList.ReadingListID == 0;

            if (currentReadingList.BookId == 0)
            {
                ShowModalError("Please select a book.", "VALIDATION_ERROR");
                return;
            }

            HttpResponseMessage response;
            if (isCreate)
            {
                Console.WriteLine($"Creating new reading list item for BookId: {currentReadingList.BookId}");
                response = await Http.PostAsJsonAsync("api/ReadingList", currentReadingList);
            }
            else
            {
                Console.WriteLine($"Updating reading list item ID: {currentReadingList.ReadingListID}");
                response = await Http.PutAsJsonAsync($"api/ReadingList/{currentReadingList.ReadingListID}", currentReadingList);
            }

            var jsonContent = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Save Response: {jsonContent.Substring(0, Math.Min(200, jsonContent.Length))}...");

            var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<ReadingList>>(jsonContent, jsonOptions);

            if (apiResponse == null || !apiResponse.Success)
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to {(isCreate ? "create" : "update")} item: {response.StatusCode}"),
                    apiResponse?.ErrorCode);
                Console.WriteLine($"Error saving reading list: {modalErrorMessage} (Code: {modalErrorCode})");
                return;
            }

            showModal = false;
            await LoadReadingList();
            ShowSuccessToast(isCreate ? "Reading list item created successfully" : "Reading list item updated successfully");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception saving reading list: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");

            ShowModalError($"Error saving item: {ex.Message}", "EXCEPTION");
            StateHasChanged();
        }
    }

    private async Task DeleteReadingList(ReadingList item)
    {
        Console.WriteLine($"Delete button clicked for item ID: {item.ReadingListID}");
        ClearModalError();
        itemToDelete = item;
        showDeleteModal = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void CloseDeleteModal()
    {
        Console.WriteLine("Closing delete modal");
        ClearModalError();
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null)
        {
            Console.WriteLine("No item to delete");
            return;
        }

        try
        {
            ClearError();
            ClearModalError();

            Console.WriteLine($"Attempting to delete reading list item ID: {itemToDelete.ReadingListID}");
            var response = await Http.DeleteAsync($"api/ReadingList/{itemToDelete.ReadingListID}");
            var jsonContent = await response.Content.ReadAsStringAsync();

            Console.WriteLine($"Delete Response: {jsonContent.Substring(0, Math.Min(200, jsonContent.Length))}...");

            var apiResponse = System.Text.Json.JsonSerializer.Deserialize<ApiResponse<object>>(jsonContent, jsonOptions);

            if (apiResponse != null && apiResponse.Success)
            {
                Console.WriteLine($"Successfully deleted reading list item ID: {itemToDelete.ReadingListID}");

                readingList.RemoveAll(x => x.ReadingListID == itemToDelete.ReadingListID);

                showDeleteModal = false;
                itemToDelete = null;

                StateHasChanged();

                await LoadReadingList();
                ShowSuccessToast("Reading list item deleted successfully");
            }
            else
            {
                ShowModalError(apiResponse?.GetUserMessage($"Failed to delete item: {response.StatusCode}"),
                    apiResponse?.ErrorCode);
                Console.WriteLine($"Error deleting reading list: {modalErrorMessage} (Code: {modalErrorCode})");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception deleting reading list: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");

            ShowModalError($"Error deleting item: {ex.Message}", "EXCEPTION");
        }
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "Duration", 5000);
        builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(7, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string message, string? code = null)
    {
        modalErrorMessage = message;
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        showSuccessToast = false;
        successMessage = null;
        StateHasChanged();
    }
}
