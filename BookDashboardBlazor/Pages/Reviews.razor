@page "/reviews"
@using BookDashboardBlazor.Models
@using System.Text.Json
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@attribute [Authorize]

<h3>Reviews</h3>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <Toast Visible="showSuccessToast"
           Type="ToastType.Success"
           Message="@(successMessage ?? string.Empty)"
           OnClose="HideSuccessToast"
           CssClass="shadow" />
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<button class="btn btn-primary mb-3" @onclick="OpenCreateModal">Add Review</button>

<GenericTable TItem="Review" Items="reviews" OnEdit="@OpenEditModal" OnDelete="@DeleteReview">
    <TableHeader>
        <th>ID</th>
        <th>Book</th>
        <th>Rating</th>
        <th>Text</th>
        <th>Created At</th>
    </TableHeader>
    <RowTemplate Context="review">
        <td>@review.ReviewID</td>
        <td>@GetBookTitle(review.BookId)</td>
        <td>@review.Rating</td>
        <td>@review.ReviewText</td>
        <td>@review.CreatedAt.ToShortDateString()</td>
    </RowTemplate>
</GenericTable>

<Modal Show="showModal" Title="@modalTitle" OnClose="CloseModal" ToastContent="ModalToast">
    <EditForm Model="@currentReview" OnValidSubmit="SaveReview">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Book</label>
            <InputSelect @bind-Value="currentReview.BookId" class="form-select">
                <option value="0">Select Book</option>
                @foreach (var book in books)
                {
                    <option value="@book.BookId">@book.Title</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label>Rating (1-5)</label>
            <InputNumber @bind-Value="currentReview.Rating" class="form-control" />
        </div>
        <div class="mb-3">
            <label>Review Text</label>
            <InputTextArea @bind-Value="currentReview.ReviewText" class="form-control" />
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </EditForm>
</Modal>

<Modal Show="showDeleteModal" Title="Confirm Delete" OnClose="CloseDeleteModal" ToastContent="ModalToast">
    <p>Are you sure you want to delete this review for <strong>@GetBookTitle(itemToDelete?.BookId ?? 0)</strong>?</p>
    <div class="mt-3">
        <button class="btn btn-danger me-2" @onclick="ConfirmDelete">Delete</button>
        <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
    </div>
</Modal>

@code {
    private List<Review> reviews = new();
    private List<Book> books = new();
    private ReviewFormModel currentReview = new();
    private int editingReviewId;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private Review? itemToDelete = null;
    private string modalTitle = "Add Review";

    private string? modalErrorMessage;
    private string? modalErrorCode;
    private string? successMessage;
    private bool showSuccessToast;
    private string? errorMessage;

    private readonly System.Text.Json.JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            errorMessage = null;
            var reviewResponse = await Http.GetAsync("api/Review");
            var bookResponse = await Http.GetAsync("api/Books");

            if (reviewResponse.IsSuccessStatusCode)
            {
                var jsonContent = await reviewResponse.Content.ReadAsStringAsync();
                var serverMessage = DeserializeServerMessage<List<Review>>(jsonContent, "[Reviews] LoadData");
                
                if (serverMessage?.Data != null)
                {
                    reviews = serverMessage.Data;
                }
                else
                {
                    reviews = new List<Review>();
                    errorMessage = "Failed to parse reviews response.";
                    Console.WriteLine("Failed to parse reviews response.");
                }
            }
            else
            {
                reviews = new List<Review>();
                var jsonContent = await reviewResponse.Content.ReadAsStringAsync();
                var serverMessage = DeserializeServerMessage<object>(jsonContent, "[Reviews] LoadData");
                errorMessage = serverMessage?.GetMessageOr($"Error loading reviews: {reviewResponse.StatusCode}") 
                               ?? $"Error loading reviews: {reviewResponse.StatusCode}";
                Console.WriteLine($"Error loading reviews: {reviewResponse.StatusCode}");
            }

            if (bookResponse.IsSuccessStatusCode)
            {
                books = await bookResponse.Content.ReadFromJsonAsync<List<Book>>() ?? new List<Book>();
            }
            else
            {
                books = new List<Book>();
                errorMessage = $"Error loading books: {bookResponse.StatusCode}";
                Console.WriteLine($"Error loading books: {bookResponse.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            reviews = new List<Review>();
            books = new List<Book>();
            errorMessage = $"Exception loading data: {ex.Message}";
            Console.WriteLine($"Exception loading data: {ex.Message}");
        }
    }

    private string GetBookTitle(int id) => books.FirstOrDefault(b => b.BookId == id)?.Title ?? "Unknown";

    private void OpenCreateModal()
    {
        ClearModalError();
        currentReview = new ReviewFormModel { Rating = 1 };
        editingReviewId = 0;
        modalTitle = "Add Review";
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Review review)
    {
        ClearModalError();
        currentReview = new ReviewFormModel
        {
            BookId = review.BookId,
            Rating = review.Rating,
            ReviewText = review.ReviewText
        };
        editingReviewId = review.ReviewID;
        modalTitle = "Edit Review";
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        ClearModalError();
        showModal = false;
        editingReviewId = 0;
        StateHasChanged();
    }

    private async Task SaveReview()
    {
        ClearModalError();
        var isCreate = editingReviewId == 0;

        try
        {
            HttpResponseMessage response;
            if (isCreate)
            {
                var payload = new ReviewCreateDto
                {
                    BookId = currentReview.BookId,
                    Rating = currentReview.Rating,
                    ReviewText = currentReview.ReviewText
                };
                response = await Http.PostAsJsonAsync("api/Review", payload);
            }
            else
            {
                var payload = new ReviewUpdateDto
                {
                    BookId = currentReview.BookId,
                    Rating = currentReview.Rating,
                    ReviewText = currentReview.ReviewText
                };
                response = await Http.PutAsJsonAsync($"api/Review/{editingReviewId}", payload);
            }

            var jsonContent = await response.Content.ReadAsStringAsync();
            var serverMessage = DeserializeServerMessage<Review>(jsonContent, "[Reviews] SaveReview");

            if (!response.IsSuccessStatusCode)
            {
                var failureMessage = serverMessage?.GetMessageOr(BuildFallbackMessage("Failed to save review", response))
                                     ?? BuildFallbackMessage("Failed to save review", response);
                ShowModalError(failureMessage, "HTTP_ERROR");
                Console.WriteLine($"Error saving review: {failureMessage}");
                return;
            }

            showModal = false;
            editingReviewId = 0;
            currentReview = new ReviewFormModel { Rating = 1 };
            StateHasChanged();
            await LoadData();
            var toastMessage = serverMessage?.GetMessageOr(isCreate
                ? "Review created successfully."
                : "Review updated successfully.") ?? (isCreate
                ? "Review created successfully."
                : "Review updated successfully.");
            ShowSuccessToast(toastMessage);
        }
        catch (Exception ex)
        {
            ShowModalError($"Exception saving review: {ex.Message}", "EXCEPTION");
            Console.WriteLine($"Exception saving review: {ex.Message}");
        }
    }

    private Task DeleteReview(Review review)
    {
        ClearModalError();
        itemToDelete = review;
        showDeleteModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ConfirmDelete()
    {
        if (itemToDelete == null) return;

        try
        {
            var response = await Http.DeleteAsync($"api/Review/{itemToDelete.ReviewID}");
            var jsonContent = await response.Content.ReadAsStringAsync();
            var serverMessage = DeserializeServerMessage<object>(jsonContent, "[Reviews] ConfirmDelete");

            if (!response.IsSuccessStatusCode)
            {
                var failureMessage = serverMessage?.GetMessageOr(BuildFallbackMessage("Error deleting review", response))
                                     ?? BuildFallbackMessage("Error deleting review", response);
                ShowModalError(failureMessage, "HTTP_ERROR");
                Console.WriteLine($"Error deleting review: {failureMessage}");
                return;
            }

            showDeleteModal = false;
            itemToDelete = null;
            StateHasChanged();
            await LoadData();
            var toastMessage = serverMessage?.GetMessageOr("Review deleted successfully.") ?? "Review deleted successfully.";
            ShowSuccessToast(toastMessage);
        }
        catch (Exception ex)
        {
            ShowModalError($"Exception deleting review: {ex.Message}", "EXCEPTION");
            Console.WriteLine($"Exception deleting review: {ex.Message}");
        }
    }

    private Task CloseDeleteModal()
    {
        ClearModalError();
        showDeleteModal = false;
        itemToDelete = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private RenderFragment ModalToast => builder =>
    {
        if (string.IsNullOrWhiteSpace(modalErrorMessage))
        {
            return;
        }

        builder.OpenComponent<Toast>(0);
        builder.AddAttribute(1, "Visible", true);
        builder.AddAttribute(2, "Type", ToastType.Error);
        builder.AddAttribute(3, "Message", modalErrorMessage);
        builder.AddAttribute(4, "Code", modalErrorCode);
        builder.AddAttribute(5, "Duration", 5000);
        builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, ClearModalError));
        builder.AddAttribute(7, "CssClass", "w-100 mb-0");
        builder.CloseComponent();
    };

    private void ShowModalError(string message, string? code = null)
    {
        modalErrorMessage = message;
        modalErrorCode = code;
        StateHasChanged();
    }

    private void ClearModalError()
    {
        modalErrorMessage = null;
        modalErrorCode = null;
    }

    private void ShowSuccessToast(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();
    }

    private void HideSuccessToast()
    {
        showSuccessToast = false;
        successMessage = null;
        StateHasChanged();
    }

    private ServerMessage<T>? DeserializeServerMessage<T>(string json, string context)
    {
        if (string.IsNullOrWhiteSpace(json))
        {
            return null;
        }

        try
        {
            return JsonSerializer.Deserialize<ServerMessage<T>>(json, jsonOptions);
        }
        catch (JsonException ex)
        {
            Console.WriteLine($"{context}: JSON parse warning {ex.Message}");
            return null;
        }
    }

    private static string BuildFallbackMessage(string baseMessage, System.Net.Http.HttpResponseMessage response) =>
        $"{baseMessage} (status {(int)response.StatusCode} {response.StatusCode}).";

    private class ReviewFormModel
    {
        [Required(ErrorMessage = "Please select a book.")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a book.")]
        public int BookId { get; set; }

        [Range(1, 5, ErrorMessage = "Rating must be between 1 and 5.")]
        public int Rating { get; set; } = 1;

        public string? ReviewText { get; set; }
    }
}
