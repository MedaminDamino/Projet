@inherits LayoutComponentBase
@using BookDashboardBlazor.Services
@using System.Security.Claims
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@* 
   ROLE-BASED LAYOUT:
   - SuperAdmin/Admin: Full sidebar + header
   - User: NO sidebar, only header navigation
*@

<div class="app-container @(IsAdminOrHigher ? "" : "no-sidebar")">
    @* ═══════════════════════════════════════════════════════════════════ *@
    @* SIDEBAR: Only rendered for Admin and SuperAdmin roles               *@
    @* ═══════════════════════════════════════════════════════════════════ *@
    @if (IsAdminOrHigher)
    {
        <div class="app-sidebar">
            <NavMenu />
        </div>
    }

    <div class="app-main">
        <div class="app-topbar">
            <div class="topbar-content">
                
                @* ═══════════════════════════════════════════════════════════════════ *@
                @* HEADER NAVIGATION: Always visible for authenticated users           *@
                @* For Users, this is their ONLY navigation                            *@
                @* ═══════════════════════════════════════════════════════════════════ *@
                <div class="topbar-nav">
                    <AuthorizeView>
                        <Authorized>
                            <a href="" class="nav-link">📚 Book Dashboard</a>
                            <a href="discover" class="nav-link">Discover Books</a>
                        </Authorized>
                    </AuthorizeView>
                </div>
                
                <div class="topbar-actions">
                    <AuthorizeView>
                        <Authorized>
                            <span class="user-greeting">Hello, @context.User.Identity?.Name</span>
                            <button class="btn btn-sm btn-outline-primary" @onclick="Logout">Logout</button>
                        </Authorized>
                        <NotAuthorized>
                            <a href="login" class="btn btn-sm btn-primary">Login</a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>

        <div class="app-content">
            <ErrorBoundary>
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent>
                    <div class="error-state">
                        <p>An error occurred. Please refresh the page.</p>
                    </div>
                </ErrorContent>
            </ErrorBoundary>
        </div>
    </div>
</div>

@code {
    private ClaimsPrincipal? user;

    /// <summary>
    /// Returns true if the user has SuperAdmin role (case-insensitive).
    /// </summary>
    private bool IsSuperAdmin => IsInRoleCaseInsensitive(user, "SuperAdmin");

    /// <summary>
    /// Returns true if the user has Admin role (case-insensitive).
    /// </summary>
    private bool IsAdmin => IsInRoleCaseInsensitive(user, "Admin");

    /// <summary>
    /// Case-insensitive role check helper.
    /// </summary>
    private static bool IsInRoleCaseInsensitive(ClaimsPrincipal? user, string roleName)
    {
        if (user == null || string.IsNullOrWhiteSpace(roleName))
        {
            return false;
        }

        // Check standard IsInRole first (for exact match)
        if (user.IsInRole(roleName))
        {
            return true;
        }

        // Check all role claims case-insensitively
        var roleClaims = user.Claims
            .Where(c => c.Type == ClaimTypes.Role || c.Type == "role" || c.Type.Contains("role", StringComparison.OrdinalIgnoreCase))
            .Select(c => c.Value);

        return roleClaims.Any(role => 
            string.Equals(role, roleName, StringComparison.OrdinalIgnoreCase));
    }

    /// <summary>
    /// Returns true if the user is SuperAdmin OR Admin.
    /// Used to determine if sidebar should be shown.
    /// </summary>
    private bool IsAdminOrHigher => IsSuperAdmin || IsAdmin;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = authState.User;

        // Subscribe to authentication state changes for immediate UI updates
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        user = authState.User;
        await InvokeAsync(StateHasChanged);
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        NavigationManager.NavigateTo("/login");
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
