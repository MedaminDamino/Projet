@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider

@* 
   SIDEBAR NAVIGATION - Admin/SuperAdmin Only
   (Home and Discover are in the header, not here)
*@

<div class="sidebar-header">
    <a href="" class="sidebar-brand">
        <span class="brand-icon">ğŸ“š</span>
        <span class="brand-text">BookDashboard</span>
    </a>
</div>

<nav class="sidebar-nav">
    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    @* SECTION: Management Pages (Admin + SuperAdmin)                       *@
    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="nav-section-label">Management</div>

    <NavLink class="nav-item" href="books">
        <span class="nav-icon">ğŸ“–</span>
        <span class="nav-text">Books</span>
    </NavLink>

    <NavLink class="nav-item" href="authors">
        <span class="nav-icon">âœï¸</span>
        <span class="nav-text">Authors</span>
    </NavLink>

    <NavLink class="nav-item" href="genres">
        <span class="nav-icon">ğŸ·ï¸</span>
        <span class="nav-text">Genres</span>
    </NavLink>

    <NavLink class="nav-item" href="reviews">
        <span class="nav-icon">â­</span>
        <span class="nav-text">Reviews</span>
    </NavLink>

    <NavLink class="nav-item" href="comments">
        <span class="nav-icon">ğŸ’¬</span>
        <span class="nav-text">Comments</span>
    </NavLink>

    <NavLink class="nav-item" href="goals">
        <span class="nav-icon">ğŸ¯</span>
        <span class="nav-text">Goals</span>
    </NavLink>

    <NavLink class="nav-item" href="readinglist">
        <span class="nav-icon">ğŸ“‹</span>
        <span class="nav-text">Reading List</span>
    </NavLink>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    @* SECTION: Administration (SuperAdmin Only)                            *@
    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    @if (IsSuperAdmin)
    {
        <div class="nav-section-divider"></div>
        <div class="nav-section-label">Administration</div>

        <NavLink class="nav-item" href="admin/roles">
            <span class="nav-icon">ğŸ›¡ï¸</span>
            <span class="nav-text">Roles</span>
        </NavLink>

        <NavLink class="nav-item" href="admin/user-roles">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">User Roles</span>
        </NavLink>
    }
</nav>

<div class="sidebar-footer">
    <div class="sidebar-version">v1.0.0</div>
</div>

@code {
    private ClaimsPrincipal? user;

    /// <summary>
    /// Returns true if the user has the SuperAdmin role (case-insensitive).
    /// </summary>
    private bool IsSuperAdmin => IsInRoleCaseInsensitive(user, "SuperAdmin");

    /// <summary>
    /// Case-insensitive role check helper.
    /// </summary>
    private static bool IsInRoleCaseInsensitive(ClaimsPrincipal? user, string roleName)
    {
        if (user == null || string.IsNullOrWhiteSpace(roleName))
        {
            return false;
        }

        // Check standard IsInRole first (for exact match)
        if (user.IsInRole(roleName))
        {
            return true;
        }

        // Check all role claims case-insensitively
        var roleClaims = user.Claims
            .Where(c => c.Type == ClaimTypes.Role || c.Type == "role" || c.Type.Contains("role", StringComparison.OrdinalIgnoreCase))
            .Select(c => c.Value);

        return roleClaims.Any(role => 
            string.Equals(role, roleName, StringComparison.OrdinalIgnoreCase));
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = authState.User;

        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        user = authState.User;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
